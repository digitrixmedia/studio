
/**
 * @fileoverview Firestore Security Rules for DineMitra POS.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant security model with path-based ownership for user data
 * and role-based access control for administrative functions. Authorization independence is a priority,
 * achieved by denormalizing key authorization data directly onto documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Gets the role of the currently signed-in user from their user document.
     *              Returns null if the user is not signed in or the document doesn't exist.
     */
    function getUserRole() {
      if (!isSignedIn()) {
        return null;
      }
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      if (userDoc == null || !('data' in userDoc) || !('role' in userDoc.data)) {
        return null;
      }
      return userDoc.data.role;
    }

    /**
     * @description Checks if the authenticated user has the 'super-admin' role.
     */
    function isSuperAdmin() {
      return getUserRole() == 'super-admin';
    }

    /**
     * @description Checks if the authenticated user has the 'admin' role.
     */
    function isAdmin() {
      return getUserRole() == 'admin';
    }
    
    /**
     * @description Checks if the user is a super-admin or a franchise admin.
     */
    function isAnAdmin() {
      let role = getUserRole();
      return role == 'super-admin' || role == 'admin';
    }

    /**********
     *  USERS
     *
     *  - Super Admins can manage any user document.
     *  - Users can read and update their own document.
     *  - This allows a super-admin to create new franchise admins.
     **********/
    match /users/{userId} {
      allow read: if isOwner(userId) || isSuperAdmin();
      allow list: if isSuperAdmin();
      allow create, update, delete: if isSuperAdmin();
      allow update: if isOwner(userId);

      /********** 
       *  SETTINGS (Subcollection of User)
       *
       *  - Users can read and write their own settings document.
       *  - This is used to persist UI preferences and other user-specific configurations.
       **********/
      match /settings/{settingsId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    /********** 
     *  OUTLETS
     *
     *  - An "Outlet" is conceptually managed by a user with the 'admin' role.
     *  - This ruleset scopes data (tables, menu_items, etc.) to an outlet ID.
     *  - All authenticated users belonging to an outlet can read/write data within it.
     **********/
    match /outlets/{outletId} {
      allow read, write: if isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.outletId == outletId;
      allow read, write: if isSuperAdmin();

      match /{subcollection}/{docId} {
        allow read, write: if isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.outletId == outletId;
        allow read, write: if isSuperAdmin();

        match /{nestedSubcollection}/{nestedDocId} {
           allow read, write: if isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.outletId == outletId;
           allow read, write: if isSuperAdmin();
        }
      }
    }
  }
}
