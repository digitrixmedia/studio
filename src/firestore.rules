
/**
 * @fileoverview Firestore Security Rules for DineMitra POS.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant security model. Each 'admin' user owns one or more 'outlets'.
 * Data for each outlet (menu, tables, orders) is stored in subcollections under that outlet's document.
 * Access is granted based on a user's `outletId` claim, which must match the `outletId` in the resource path.
 * This ensures strict data isolation between different franchise outlets.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Gets the role of the currently signed-in user from their user document.
     *              Returns null if the user is not signed in or the document doesn't exist.
     */
    function getUserRole() {
      if (!isSignedIn()) {
        return null;
      }
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      if (userDoc == null || !('data' in userDoc) || !('role' in userDoc.data)) {
        return null;
      }
      return userDoc.data.role;
    }

    /**
     * @description Checks if the authenticated user has the 'super-admin' role.
     */
    function isSuperAdmin() {
      return getUserRole() == 'super-admin';
    }
    
    /**
     * @description Checks if the user belongs to the target outlet.
     *              The user document must contain an 'outletId' that matches the outletId from the URL.
     */
    function belongsToOutlet(outletId) {
        let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
        return isSignedIn() && userDoc != null && userDoc.data.outletId == outletId;
    }


    /**********
     *  USERS
     *
     *  - Super Admins can manage any user document.
     *  - Users can read and update their own document.
     *  - Franchise Admins can create/manage users for their own outlet.
     **********/
    match /users/{userId} {
      allow read, update: if isOwner(userId);
      allow create, update, delete, list: if isSuperAdmin();
      // Allow a franchise admin to manage users in their own outlet
      allow create, list: if getUserRole() == 'admin' && request.resource.data.outletId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.outletId;
      allow read, update, delete: if getUserRole() == 'admin' && get(/databases/$(database)/documents/users/$(userId)).data.outletId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.outletId;
    }
    
    /********** 
     *  OUTLETS
     *
     *  - An "Outlet" is the top-level document for a franchise location.
     *  - Super Admins can manage all outlets.
     *  - Franchise Admins ('admin' role) can manage their own outlet document.
     *  - All data for an outlet (menu, orders, tables, settings) is stored in subcollections.
     *  - Any authenticated user belonging to an outlet can read/write data within that outlet's subcollections.
     **********/
    match /outlets/{outletId} {
      // Super admins have full access. Franchise Admins & their staff can read their own outlet doc.
      allow read: if isSuperAdmin() || belongsToOutlet(outletId);
      
      // Only Super Admins can create or delete outlets.
      allow create, delete: if isSuperAdmin();

      // Franchise owner can update their own outlet document.
      allow update: if getUserRole() == 'admin' && belongsToOutlet(outletId);


      // Rule for outlet settings subcollection
      match /settings/{settingId} {
        // Allow read for any user belonging to the outlet.
        allow read: if belongsToOutlet(outletId);
        // Only allow write for the super-admin or the admin of that specific outlet.
        allow write: if isSuperAdmin() || (getUserRole() == 'admin' && belongsToOutlet(outletId));
      }

      // Rule for all other subcollections within an outlet.
      match /{subcollection}/{docId=**} {
         // Any user (cashier, waiter, manager) who belongs to the outlet can read/write data within it.
         // This rule excludes the 'settings' subcollection, which has its own more specific rule above.
         allow read, write: if belongsToOutlet(outletId) && subcollection != 'settings';
      }
    }
  }
}
